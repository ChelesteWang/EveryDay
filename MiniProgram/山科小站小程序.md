
# 山科小站

> 山东科技大学校园小程序，如果觉得不错，点个star吧 :-)
> Github：https://github.com/WindrunnerMax/SW

## 一、微信小程序转UNIAPP
> 最近转微信小程序项目到UNIAPP项目遇到的的一些注意事项和坑
> 整体来说迁移项目并不是很复杂，更多的是一些重复的工作

### 1. 文件对应关系

```javascript
<template></template> 对应.wxml文件
<script></script> 对应.js文件
<style></style> 对应.wxss文件
在使用HBuildX创建.vue文件时会自动创建模板
```

### 2. App.vue文件

```javascript
globalData、onPageNotFound()、onLaunch()定义于此
在 onLaunch() 中直接绑定于app的方法需要操作this.$scope
```

### 3. 自定义组件

```javascript
created()方法定义为组件创建执行的方法
<slot></slot>作为组件xml插入点，可设置name属性设置多个插入点
组件单独挂载，在.vue文件引入后组件，在export default{components: {}}声明引入组件名
全局挂载组件，在main.js引入并挂载import example from "example.vue"; Vue.component('example',example);
```

### 4. 自定义文件夹

```javascript
自定义文件夹在打包时会自动编译到/common/下
静态资源放入static中，打包时目录不会变动，wxml引入目录不变
```

### 5. 数据绑定

```javascript
微信小程序中使用 setData({}) 方法将数据发送到视图层
Vue中数据双向绑定，使用 this.param = value 重新渲染数据，
当然也可以重写 setData({}) 方法，官网给予示例
setData:function(obj){    
let that = this;    
let keys = [];    
let val,data;    
Object.keys(obj).forEach(function(key){    
 keys = key.split('.');    
 val = obj[key];    
 data = that.$data;    
 keys.forEach(function(key2,index){    
     if(index+1 == keys.length){    
         that.$set(data,key2,val);    
     }else{    
         if(!data[key2]){    
            that.$set(data,key2,{});    
         }    
     }    
     data = data[key2];    
 })    
});    
}  
```

### 6. template数据渲染

```javascript
要使用的数据必须首先在export default {data() {return { param : value}}}中声明
在xml节点属性中使用:attr引用变量值，在xml节点的值使用{{param}}
循环wx:for="{{list}}" wx:key="{{index}}"> 改为 v-for="(item,index) in list" :key="index"
```

### 7. 动态绑定class与style


```javascript
在ES6中可直接在:attr中使用新特性`string${param}string`来拼接字符串，但是微信小程序还不支持
手动拼接字符串的方式:attr="'string' + param"
Vue中提供了动态绑定的方式 <view class="static" :class="{value:active}" :style="{'attr': param}"></view>
```


### 8. page.json

```javascript
在微信小程序的app.json路由在Unaipp中同样由page.json文件统一管理
微信小程序时在app.json中写入路由则创建文件，HbuildX中在创建页面时可选自动在page.json创建路由
在page.json中style对应微信小程序某一页面的json文件
```

### 9. 条件编译功能

```javascript
// #ifdef  %PLATFORM%
平台特有的API实现，UNIAPP提供的条件编译功能，非常适用于跨端开发
// #endif
```

### 10. 阿里矢量图标库Iconfont

```javascript
将图标添加到项目，以代码的方式下载到本地
复制iconfont.css到项目，移除所有类似 url('iconfont.eot?t=1577846073653#iefix') format('embedded-opentype') 部分
在<view class='iconfont icon-shuaxin'></view>引用即可
```



## 二、山科小站实例

### 1. 目录结构

```javascript
SHST-UNI                              // 山科小站总目录
    ├── components                    // 组件封装
    │   ├── headslot.vue              // 带solt的标题布局
    │   ├── layout.vue                // 卡片式布局
    │   ├── list.vue                  // 展示用list布局
    │   ├── sentence.vue              // 每日一句封装
    │   └── weather.vue               // 天气封装
    ├── pages                         // 页面
    │   ├── Ext                       // 拓展组
    │   ├── Home                      // Tabbar、辅助组
    │   ├── Lib                       // 图书馆功能组
    │   ├── Sdust                     // 科大组
    │   ├── Study                     // 学习组
    │   └── User                      // 用户组
    ├── static                        // 静态资源
    │   ├── camptour                  // 校园导览静态资源
    │   └── img                       // 图标等静态资源
    ├── unpackage                     // 打包文件
    ├── utils                         // 辅助功能
    │   ├── amap-wx.js                // 高德地图SDK
    │   ├── eventBus.js               // 事件消息总线封装
    │   ├── md5.js                    // MD5引入
    │   └── util.js                   // 封装时间等操作
    ├── vector                        // 拓展封装
    │   ├── camptour                  // 校园导览配置文件
    │   ├── icon                      // 矢量图标库
    │   ├── asse.wxss                 // CSS封装
    │   ├── dispose.js                // JS封装
    │   └── pubFct.js                 // 公有方法
    ├── App.vue                       // App全局样式以及监听
    ├── main.js                       // 挂载App，Vue初始化入口文件
    ├── manifest.json                 // 配置Uniapp打包等信息
    ├── pages.json                    // 路由
    └── uni.scss                      // 内置的常用样式变量
```


## 三、辅助类 util.js

### 1. 格式化时间封装

```javascript
/**
 * 格式化时间日期
 * yyyy年 MM月 dd日 hh1~12小时制(1-12) HH24小时制(0-23) mm分 ss秒 S毫秒 K周
 */
const formatDate = (fmt = "yyyy-MM-dd", date = new Date()) => {
    var week = ["星期日","星期一","星期二","星期三","星期四","星期五","星期六"];
    var o = {
        "M+": date.getMonth() + 1, //月份
        "d+": date.getDate(), //日
        "h+": date.getHours(), //小时
        "m+": date.getMinutes(), //分
        "s+": date.getSeconds(), //秒
        "q+": Math.floor((date.getMonth() + 3) / 3), //季度
        "S": date.getMilliseconds(), //毫秒
        "K": week[date.getDay()]
    };
    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
    }
    return fmt;
}
```


### 2. 拓展Data原型

```javascript
/**
 * 拓展Date原型，做时间添加
 */
const extDate = () => {
    Date.prototype.addDate = function(years = 0, months = 0, days = 0) {
        if (days !== 0) this.setDate(this.getDate() + days);
        if (months !== 0) this.setMonth(this.getMonth() + months);
        if (years !== 0) this.setFullYear(this.getFullYear() + years);
    }
}
```


### 3. 获取日期相差天数

```javascript
/**
 * 获取日期相差天数
 */
const dateDiff = (startDateString, endDateString) => {
  var separator = "-"; //日期分隔符
  var startDates = startDateString.split(separator);
  var endDates = endDateString.split(separator);
  var startDate = new Date(startDates[0], startDates[1] - 1, startDates[2]);
  var endDate = new Date(endDates[0], endDates[1] - 1, endDates[2]);
  var diff = parseInt((endDate - startDate) / 1000 / 60 / 60 / 24); //把相差的毫秒数转换为天数
  return diff;
}
```

```javascript
### 4.  时间大小比较
/**
 * 时间大小比较
 */
const compareTimeInSameDay = (t1, t2) => {
  let d = new Date()
  let ft1 = d.setHours(t1.split(":")[0], t1.split(":")[1])
  let ft2 = d.setHours(t2.split(":")[0], t2.split(":")[1])
  return ft1 > ft2
}
```


## 四、事件总线 EventBus.js

### 1. 订阅事件

```javascript
  on : function(key, handler) {
    if (!(key in this.handlers)) {
      this.handlers[key] = [];
    }
    this.handlers[key].push(handler);
  },
```


### 2. 卸载事件

```javascript
  off : function(key, handler) {
    const index = this.handlers[key].findIndex(item => {
      item === handler;
    })
    // 不存在直接返回
    if (index < 0) {
      return false;
    }

    if (this.handlers[key].length === 1) {
      // 只有一个直接删除key 节省内存
      delete this.handlers[key]
    } else {
      this.handlers[key].splice(index, 1)
    }
    return true;
  },
```


### 3. 触发事件

```javascript
  commit : function(key) {
    // 取出参数并转化为数组
    if (!this.handlers[key]) return false;
    const args = Array.prototype.slice.call(arguments, 1)
    this.handlers[key].forEach(handler => {
      // 防止this指向乱掉
      try{ handler.apply(this, args); } catch(e){console.warn(e);}
    });
    return true;
  }
```

## 五、部署类 dispose.js

### 1. 颜色方案

```javascript
/**
 * 颜色方案
 */
module.exports.colorList = ["#EAA78C", "#F9CD82", "#9ADEAD", "#9CB6E9", "#E49D9B", "#97D7D7", "#ABA0CA", "#9F8BEC",
    "#ACA4D5", "#6495ED", "#7BCDA5", "#76B4EF"
];
```


### 2. 拓展对象

```javascript
/**
 * 拓展对象
 * 浅拷贝与深拷贝
 */
function extend() {
    var aLength = arguments.length;
    var options = arguments[0];
    var target = {};
    var copy;
    var i = 1;
    if (typeof options === "boolean" && options === true) {
        //深拷贝 (仅递归处理对象)
        for (; i < aLength; i++) {
            if ((options = arguments[i]) != null) {
                if (typeof options !== 'object') {
                    return options;
                }
                for (var name in options) {
                    copy = options[name];
                    if (target === copy) {
                        continue;
                    }
                    target[name] = this.extend(true, options[name]);
                }
            }
        }
    } else {
        //浅拷贝
        target = options;
        if (aLength === i) {
            target = this;
            i--;
        } //如果是只有一个参数，拓展功能 如果两个以上参数，将后续对象加入到第一个对象
        for (; i < aLength; i++) {
            options = arguments[i];
            for (var name in options) {
                target[name] = options[name];
            }
        }
    }
    return target;
}
```


### 3. 加载封装

```javascript
/**
 * startLoading
 */
function startLoading(option) {
    switch (option.load) {
        case 1:
            uni.showNavigationBarLoading();
            break;
        case 2:
            uni.showNavigationBarLoading();
            uni.setNavigationBarTitle({
                title: '加载中...'
            })
            break;
        case 3:
            uni.showLoading({
                title: '请求中',
                mask: true
            })
            break;
    }
}

/**
 * endLoading
 */
function endLoading(option) {
    switch (option.load) {
        case 1:
            uni.hideNavigationBarLoading();
            break;
        case 2:
            uni.hideNavigationBarLoading();
            uni.setNavigationBarTitle({
                title: '山科小站'
            })
            break;
        case 3:
            uni.hideLoading();
            break;
    }
}
```

### 4. 小程序更新封装

```javascript
/**
 * 小程序更新
 */
function checkUpdate() {
    if (!uni.getUpdateManager) return false;
    uni.getUpdateManager().onCheckForUpdate((res) => {
        console.log("Update:" + res.hasUpdate);
        if (res.hasUpdate) { //如果有新版本
            uni.getUpdateManager().onUpdateReady(() => { //当新版本下载完成
                uni.showModal({
                    title: '更新提示',
                    content: '新版本已经准备好，单击确定重启应用',
                    success: (res) => {
                        if (res.confirm) uni.getUpdateManager().applyUpdate(); //applyUpdate 应用新版本并重启
                    }
                })
            })
            uni.getUpdateManager().onUpdateFailed(() => { //当新版本下载失败
                uni.showModal({
                    title: '提示',
                    content: '检查到有新版本，但下载失败，请检查网络设置',
                    showCancel: false
                })
            })
        }
    })
}
```


### 5. Dot提示公告

```javascript
/**
 * User显示Dot
 */
function userDot(notify, app = getApp()) {
    app.globalData.tips = notify;
    if (!uni.showTabBarRedDot) return false;
    uni.getStorage({
        key: 'point',
        complete: (res) => {
            if (res.data !== app.globalData.tips) {
                uni.showTabBarRedDot({
                    index: 2
                })
            }
        }
    })
}
```


### 6. Cookies自动处理

```javascript
/**
 * SetCookie
 */
function setCookie(res, app = getApp()) {
    if (app.globalData.header.Cookie === "") {
        if (res && res.header && res.header['Set-Cookie']) {
            var cookies = res.header['Set-Cookie'].split(";")[0] + ";";
            console.log("SetCookie:" + cookies);
            app.globalData.header.Cookie = cookies;
            uni.setStorage({
                key: "cookies",
                data: app.globalData.header.Cookie
            });
        } else {
            console.log("Get Cookie From Cache");
            app.globalData.header.Cookie = uni.getStorageSync("cookies") || "";
        }
    }
}
```


### 7. Toast弹窗提示

```javascript
/**
 * 弹窗提示
 */
function toast(e, time = 2000, icon = 'none') {
    uni.showToast({
        title: e,
        icon: icon,
        duration: time
    })
}
```


### 8. 封装HTTP请求

```javascript
/**
 * HTTP请求
 */
function ajax(requestInfo, app = getApp()) {
    var option = {
        load: 1,
        autoCookie: true,
        url: "",
        method: "GET",
        data: {},
        fun: () => {},
        success: () => {},
        fail: function() {
            this.completeLoad = () => {
                toast("服务器错误");
            }
        },
        complete: () => {},
        completeLoad: () => {}
    };
    extend(option, requestInfo);
    startLoading(option);
    uni.request({
        url: option.url,
        data: option.data,
        method: option.method,
        header: app.globalData.header,
        success: (res) => {
            if (option.autoCookie) setCookie(res);
            try {
                option.fun(res);
                option.success(res);
            } catch (e) {
                option.completeLoad = () => {
                    toast("PARSE ERROR");
                }
                console.warn(e);
            }
        },
        fail: (res) => {
            option.fail(res);
        },
        complete: function(res) {
            endLoading(option);
            try {
                option.complete(res);
            } catch (e) {
                console.warn(e);
            }
            option.completeLoad(res);
        }
    })
}
```

### 9. APP启动事件

```javascript
/**
 * APP启动事件
 */
function onLunch() {
    var app = this;
    app.$scope.eventBus = eventBus.getEventBus;
    uni.login({
        success: res => {
            ajax({
                load: 3,
                // #ifdef MP-WEIXIN
                url: app.globalData.url + 'auth/wx',
                // #endif
                // #ifdef MP-QQ
                url: app.globalData.url + 'auth/QQ',
                // #endif
                method: 'POST',
                autoCookie: false,
                data: {
                    "code": res.code
                },
                success: (res) => {
                    setCookie(res, app);
                    app.globalData.curTerm = res.data.initData.curTerm
                    app.globalData.curWeek = res.data.initData.curWeek
                    app.globalData.loginStatus = res.data.Message;
                    app.globalData.initData = res.data.initData;
                    if (res.data.Message === "Ex") app.globalData.userFlag = 1;
                    else app.globalData.userFlag = 0;
                    console.log("Status:" + (app.globalData.userFlag === 1 ? "User Login" : "New User"));
                    if (res.data.openid) {
                        userDot(res.data.initData.tips, app);
                        console.log("SetOpenid:" + res.data.openid);
                        app.globalData.openid = res.data.openid;
                        uni.setStorageSync('openid', res.data.openid);
                    } else {
                        console.log("Get Openid From Cache");
                        app.globalData.openid = uni.getStorageSync("openid") || "";
                    }
                },
                complete: (res) => {
                    if (res.statusCode !== 200 || !res.data.initData || !res.data.initData.curTerm) {
                        uni.showModal({
                            title: '警告',
                            content: '数据初始化失败,点击确定重新初始化数据',
                            showCancel: false,
                            success: (res) => {
                                if (res.confirm) onLunch.apply(app);
                            }
                        })
                    } else {
                        app.$scope.eventBus.commit('LoginEvent', res);
                    }
                }
            }, app)
        }
    })
}
```


## 六、App部署 App.vue
### 1. 部署App
```javascript
    const dispose = require('vector/dispose.js');                    //引入部署类
    export default {
        globalData: {                                            //声明全局变量
            tips: "0",
            openid: "",
            userFlag: 0, // 0 未登录 1 已登陆
            initData: {},
            version: "3.0.2",
            curTerm: "2019-2020-1",
            curTermStart: "2019-08-26",
            colorList: dispose.colorList,
            url: 'https://www.touchczy.top/',
            // url: 'http://127.0.0.1/Swisdom/Web/index.php/',
            header: {'Cookie': '','content-type': 'application/x-www-form-urlencoded'}
        },
        onPageNotFound: (res) => { //处理404
            uni.reLaunch({
                url: 'pages/Home/auxiliary/notFound'
            })
        },
        onLaunch: function() {
            console.log("APP INIT");
            dispose.onLunch.apply(this); //启动加载事件
            const util = require('utils/util.js');
            const pubFct = require('vector/pubFct.js');
            util.extDate(); //拓展Date原型
            dispose.checkUpdate(); //小程序更新
            this.globalData.colorN = this.globalData.colorList.length;
            this.globalData.curWeek = pubFct.getCurWeek(this.globalData.curTermStart);
            this.$scope.extend = dispose.extend;
            this.$scope.extend({
              toast: dispose.toast,
              ajax: dispose.ajax
            });
        }
    }
```

### 2. 全局样式

```css
/*全局样式*/
@import '/vector/asse.wxss';
@import "/vector/icon/iconfont.wxss";
page{
    font-family: Arial, Helvetica, 'STHeiti STXihei', 'Microsoft YaHei', Tohoma, sans-serif;
    padding: 10px;
    box-sizing: border-box;
    font-size: 15px;
    background-color: #F8F8F8;
}
.link{
  color: #4C98F7;
  text-decoration: underline;
}
.x-CenterCon{
    display: flex;
    justify-content: center;
}
.dot{
    width: 8px;
    height: 8px;
    border-radius: 8px;
}
.y-CenterCon{
    display: flex;
    align-items: center;
}
button:after {
  border: none;
}

button {
  background: #fff;
  border: none;
  box-sizing: unset;
  padding: 0;
  margin: 0;
  font-size: 13px;
  line-height: unset;
}
.adapt{
    box-sizing: border-box;
}
.tipsCon view{
    padding: 5px;
}
```









